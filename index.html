<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
  </head>
  <body>
    <h1>Hello there</h1>
    <p>Have your say:</p>
    <form id="fileForm">
      <input name="filename" />
      <textarea name="content"></textarea>
      <input type="submit" value="send" />
    </form>

    <post-list></post-list>

  </body>
  <script src="script.js" ></script>
  <script type="text/javascript">

    class PostList extends HTMLElement {
      constructor() {
        super();
        let listItems = [1,2];
        const shadow = this.attachShadow({ mode: 'open' });
        const container = document.createElement('div');
        container.innerHTML = `
          <ul class="item-list">
          </ul>
        `;
        shadow.appendChild(container);
      }

      async connectedCallback() {
        let files = await loadContent();
        let domList = this.shadowRoot.querySelector('.item-list');
        for (let f of files){
          let {filename, link} = f;
          let li = document.createElement('li');
          let a = document.createElement('a');
          a.href = link;
          a.textContent = filename;
          li.appendChild(a)
          domList.appendChild(li);
        }
      }

    }
    customElements.define('post-list', PostList);

    async function addFile(file, filename){
      // # add file to a folder - need CID of current folder, if none, doesn't matter?
      // Current CID of folder?
      // NEW_CID = post to /ipfs/CID/path/file
      // update ipns

      let lastCid = window.localStorage.getItem('lastCid');
      let url = `ipfs://${lastCid?lastCid:''}/ipmb-db/${filename}`

      response = await fetch(url, {
        method: 'POST',
        body: file,
        mode: 'cors'
      });

      const finalUrl = await response.text()
      lastCid = new URL(finalUrl).host;

      // TODO update IPNS
      // r = fetch('ipns://ipmb', {method: 'POST', body: lastCid})

      window.localStorage.lastCid = lastCid;
      console.log(finalUrl);
      return lastCid;
    }

    async function submitForm(event){
      event.preventDefault();
      let text = document.querySelector('textarea[name="content"]').value;
      let filename = document.querySelector('input[name="filename"]').value;
      var file = new File([text], filename, {
        type: "text/plain",
      });
      let lastCid = await addFile(file, filename)
      console.log(lastCid);
    }

    async function loadContent(){
      // this is a workaround the current incorrect behavior where js-ipfs-fetch nests folders when adding a file to a folder
      async function _fetchRecursive(cid){
        // first get file
        let r = await fetch(`ipfs://${cid}/ipmb-db/`);
        let d = await r.json();
        let filename = d[0];
        let fileRequest = await fetch(`ipfs://${cid}/ipmb-db/${filename}`);
        let content = await fileRequest.text();

        // read nested dir
        let dr = await fetch(`ipfs://${cid}/`);
        let dd = await dr.json();
        let nestedDirs = dd.filter( dirname => dirname != 'ipmb-db/' );
        if (nestedDirs.length == 1){
          let newCid = nestedDirs[0].split('/')[0];
          let files = await _fetchRecursive(newCid);
          return [ ...files, { filename, content, link: `ipfs://${cid}/ipmb-db/${filename}` } ];
        } else {
          return [ { filename, content, link: `ipfs://${cid}/ipmb-db/${filename}` } ]
        }
      }
      let lastCid = window.localStorage.getItem('lastCid');
      let files = _fetchRecursive(lastCid);
      console.log(files);
      return files;
    }

    document.addEventListener("DOMContentLoaded", function(event) {
      console.log('beep');
      document.querySelector('#fileForm').onsubmit = submitForm;
    });

  </script>
</html>

