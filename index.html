<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
  </head>
  <body>
    <h1>Hello there</h1>
    <p>Have your say:</p>
    <form id="fileForm">
      <input name="filename" />
      <textarea name="content"></textarea>
      <input type="submit" value="send" />
    </form>

  </body>
  <script src="script.js" ></script>
  <script type="text/javascript">

    async function addFile(file, filename){
      // # add file to a folder - need CID of current folder, if none, doesn't matter?
      // Current CID of folder?
      // NEW_CID = post to /ipfs/CID/path/file
      // update ipns

      let lastCid = window.localStorage.getItem('lastCid');
      let url = `ipfs://${lastCid?lastCid:''}/ipmb-db/${filename}`

      response = await fetch(url, {
        method: 'POST',
        body: file,
        mode: 'cors'
      });

      const finalUrl = await response.text()
      lastCid = new URL(finalUrl).host;

      // TODO update IPNS
      // r = fetch('ipns://ipmb', {method: 'POST', body: lastCid})

      window.localStorage.lastCid = lastCid;
      console.log(finalUrl);
      return lastCid;
    }

    async function submitForm(event){
      event.preventDefault();
      let text = document.querySelector('textarea[name="content"]').value;
      let filename = document.querySelector('input[name="filename"]').value;
      var file = new File([text], filename, {
        type: "text/plain",
      });
      let lastCid = await addFile(file, filename)
      console.log(lastCid);
    }

    document.addEventListener("DOMContentLoaded", function(event) {
      console.log('beep');
      document.querySelector('#fileForm').onsubmit = submitForm;
    });

  </script>
</html>

